#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DNS —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash update-dns-db.sh [DNS]

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

DNS="${1:-1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4}"

echo -e "${BLUE}üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DNS —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
if ! systemctl is-active --quiet postgresql; then
    echo -e "${RED}‚ùå PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
    exit 1
fi

echo -e "${YELLOW}–û–±–Ω–æ–≤–ª—è—é DNS –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤: $DNS${NC}"

# –û–±–Ω–æ–≤–ª—è–µ–º DNS –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
sudo -u postgres psql -d vpn_service -c "UPDATE vpn_servers SET dns = '$DNS';"

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ DNS —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!${NC}"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  –í–∞–∂–Ω–æ:${NC}"
    echo -e "${YELLOW}–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π DNS.${NC}"
    echo -e "${YELLOW}–ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π DNS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ DNS${NC}"
    exit 1
fi

