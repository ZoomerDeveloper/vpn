# Решение проблем с VPN для пользователей из РФ

## Симптомы

- VPN подключается, но сайты не открываются
- DNS не резолвится
- Интернет работает без VPN, но не работает через VPN

## Причины

1. **DNS запросы блокируются** - основная причина
2. **IP адрес VPN сервера заблокирован**
3. **WireGuard трафик блокируется** (DPI)
4. **Неправильная маршрутизация**

## Решения

### 1. Обновление DNS (Быстрое решение)

Используйте надежные DNS серверы через VPN:

```bash
# Обновить DNS для сервера
cd /opt/vpn-service/scripts
bash update-server-dns.sh http://localhost:3000

# Или вручную через API
curl -X PATCH http://localhost:3000/wireguard/servers/SERVER_ID \
  -H "Content-Type: application/json" \
  -d '{"dns": "1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4"}'
```

### 2. Рекомендуемые DNS для РФ

- **Cloudflare:** `1.1.1.1, 1.0.0.1` (лучше работает в РФ)
- **Google:** `8.8.8.8, 8.8.4.4`
- **AdGuard:** `94.140.14.14, 94.140.15.15`
- **Quad9:** `9.9.9.9, 149.112.112.112`

**Рекомендация:** Используйте `1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4` (несколько DNS для надежности)

### 3. Проверка подключения

На устройстве пользователя (Android/iOS):

1. **Проверьте что VPN подключен:**
   - В приложении WireGuard должен быть статус "Подключено"

2. **Проверьте IP адрес:**
   ```bash
   # На Android через ADB или терминал
   curl ifconfig.me
   # Должен показать IP VPN сервера, а не ваш реальный IP
   ```

3. **Проверьте DNS:**
   ```bash
   # Проверка DNS резолвинга
   nslookup google.com
   # Должен резолвить адрес
   ```

### 4. Настройка собственного DNS на сервере (Продвинутое)

Если стандартные DNS не работают, можно настроить собственный DNS сервер:

```bash
cd /opt/vpn-service/scripts
bash configure-dns-server.sh
```

Это установит dnsmasq на VPN сервере и настроит его как DNS для клиентов.

### 5. Проверка на сервере

```bash
# Проверить что WireGuard работает
sudo wg show wg0

# Проверить маршрутизацию
sudo iptables -t nat -L POSTROUTING -v -n

# Проверить IP forwarding
sysctl net.ipv4.ip_forward

# Проверить что DNS работает
dig @1.1.1.1 google.com
```

### 6. Проверка конфигурации клиента

Убедитесь что в конфигурации WireGuard:

```
[Interface]
PrivateKey = ...
Address = 10.0.0.2/32
DNS = 1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4

[Peer]
PublicKey = ...
Endpoint = ...
AllowedIPs = 0.0.0.0/0,::/0
PersistentKeepalive = 25
```

**Важно:**
- `AllowedIPs = 0.0.0.0/0,::/0` - весь трафик идет через VPN
- `DNS` должен быть указан и содержать надежные DNS серверы
- `PersistentKeepalive = 25` - важно для обхода NAT

### 7. Пересоздание конфигурации

Если DNS обновлен, пользователю нужно:

1. Удалить старую конфигурацию из WireGuard
2. Получить новую конфигурацию через бота (`/devices` → создать новое устройство)
3. Импортировать новую конфигурацию

Или можно обновить DNS вручную в существующей конфигурации.

### 8. Альтернативные решения

Если проблемы продолжаются:

1. **Изменить порт WireGuard** (если блокируется):
   ```bash
   # На сервере изменить порт в /etc/wireguard/wg0.conf
   # Обновить в базе данных
   ```

2. **Использовать obfuscation** (требует дополнительной настройки)

3. **Проверить что IP сервера не заблокирован** в РФ

## Диагностика на стороне пользователя

### Android

1. Открыть WireGuard приложение
2. Проверить статус подключения
3. Нажать на конфигурацию → "Посмотреть логи"
4. Проверить что есть handshake

### iOS

1. Открыть WireGuard приложение
2. Проверить что туннель активен (зеленая точка)
3. Перейти в Settings → WireGuard → посмотреть статистику

### Общие проверки

```bash
# Проверка DNS
nslookup google.com

# Проверка подключения
ping 8.8.8.8

# Проверка маршрутизации
traceroute 8.8.8.8
```

## Быстрое решение для пользователя

Если пользователь из РФ не может подключиться:

1. **Убедитесь что DNS обновлен на сервере** (см. выше)
2. **Попросите пользователя:**
   - Удалить старую конфигурацию
   - Получить новую через бота
   - Подключиться снова
3. **Если не помогает:**
   - Проверьте логи WireGuard на устройстве
   - Проверьте что IP сервера доступен из РФ
   - Проверьте что порт 51820/UDP открыт

