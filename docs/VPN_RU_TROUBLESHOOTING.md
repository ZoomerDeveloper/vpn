# Подробная диагностика VPN для пользователей из РФ

## Быстрая диагностика

### На сервере

```bash
cd /opt/vpn-service/scripts

# Диагностика конкретного пользователя
bash diagnose-vpn-ru-detailed.sh http://localhost:3000 USER_ID

# Общая диагностика
bash diagnose-ru-vpn.sh http://localhost:3000 USER_ID
```

### Проверка на устройстве пользователя

1. **VPN подключен?**
   - Открыть WireGuard приложение
   - Проверить что статус "Подключено" (зеленая точка)

2. **IP адрес:**
   ```bash
   curl ifconfig.me
   # Должен показать IP VPN сервера (199.247.7.185), а НЕ ваш реальный IP
   ```

3. **DNS резолвинг:**
   ```bash
   nslookup google.com
   # Должен резолвить адрес
   ```

4. **Доступность сайтов:**
   ```bash
   curl -v https://google.com
   # Должен успешно подключиться
   ```

## Возможные проблемы и решения

### 1. Пользователь использует старую конфигурацию

**Симптомы:**
- VPN подключается, но сайты не открываются
- DNS запросы не проходят

**Решение:**
Пользователю нужно **пересоздать конфигурацию**:

1. Удалить старую конфигурацию из WireGuard приложения
2. Отправить `/devices` в боте
3. Создать новое устройство
4. Получить новую конфигурацию с обновленным DNS
5. Импортировать и подключиться

**Или на сервере:**
```bash
cd /opt/vpn-service/scripts
bash recreate-user-config.sh USER_ID
```

### 2. DNS запросы блокируются

**Симптомы:**
- VPN подключен
- IP адрес правильный (IP сервера)
- Но сайты не открываются
- DNS запросы не проходят

**Решение:**

#### Вариант A: Обновить DNS на сервере

```bash
cd /opt/vpn-service/scripts
bash fix-dns-russia.sh http://localhost:3000
```

Или использовать только Cloudflare DNS (обычно лучше работает в РФ):

```bash
bash fix-dns-russia.sh http://localhost:3000 "1.1.1.1,1.0.0.1"
```

#### Вариант B: Использовать только один DNS

Попробуйте только Cloudflare:
```
DNS = 1.1.1.1
```

Или только Google:
```
DNS = 8.8.8.8
```

#### Вариант C: Настроить собственный DNS на сервере

```bash
cd /opt/vpn-service/scripts
bash configure-dns-server.sh
```

Это установит локальный DNS на VPN сервере.

### 3. WireGuard трафик блокируется (DPI)

**Симптомы:**
- VPN не подключается вообще
- Handshake не происходит
- В логах WireGuard нет соединений

**Решение:**

#### Изменить порт WireGuard

1. Отредактировать `/etc/wireguard/wg0.conf`:
   ```
   ListenPort = 51821  # или другой порт
   ```

2. Перезапустить WireGuard:
   ```bash
   sudo systemctl restart wg-quick@wg0
   ```

3. Обновить порт в базе данных:
   ```bash
   sudo -u postgres psql -d vpn_service -c "UPDATE vpn_servers SET port = 51821;"
   ```

4. Пользователям нужно получить новую конфигурацию

#### Использовать нестандартный порт

Попробуйте порты:
- 443/UDP (часто не блокируется)
- 53/UDP (DNS порт, но может быть проблемы)
- 80/UDP (HTTP порт)

### 4. IP адрес сервера заблокирован

**Симптомы:**
- VPN не подключается
- Endpoint недоступен

**Решение:**
- Проверить доступность IP из РФ
- Использовать другой сервер
- Изменить IP адрес сервера

### 5. Проблемы с маршрутизацией

**Симптомы:**
- VPN подключается
- IP адрес правильный
- Но трафик не идет

**Решение:**

Проверить на сервере:
```bash
# IP forwarding
sysctl net.ipv4.ip_forward
# Должно быть: net.ipv4.ip_forward = 1

# NAT правила
sudo iptables -t nat -L POSTROUTING -v -n
# Должны быть правила MASQUERADE

# Если нет, исправить:
bash fix-wireguard-routing.sh
```

### 6. MTU проблемы

**Симптомы:**
- VPN подключается
- Медленно работает
- Часть трафика теряется

**Решение:**

Добавить в конфигурацию WireGuard:
```
[Interface]
MTU = 1420
```

Или пробовать другие значения: 1280, 1300, 1380

## Пошаговое решение проблемы

### Шаг 1: Диагностика

```bash
cd /opt/vpn-service/scripts
bash diagnose-vpn-ru-detailed.sh http://localhost:3000 USER_ID
```

### Шаг 2: Обновить DNS

```bash
# Обновить DNS на всех серверах
bash fix-dns-russia.sh http://localhost:3000 "1.1.1.1,1.0.0.1"
```

### Шаг 3: Пересоздать конфигурацию пользователя

```bash
bash recreate-user-config.sh USER_ID
```

### Шаг 4: Проверить на сервере

```bash
# Проверить WireGuard
sudo wg show wg0

# Проверить маршрутизацию
sudo iptables -t nat -L POSTROUTING -v -n
sysctl net.ipv4.ip_forward
```

### Шаг 5: Инструкции для пользователя

Попросите пользователя:

1. **Удалить старую конфигурацию** из WireGuard
2. **Получить новую** через бота (`/devices` → создать новое устройство)
3. **Импортировать новую конфигурацию**
4. **Подключиться к VPN**
5. **Проверить:**
   - IP адрес: `curl ifconfig.me` (должен быть IP сервера)
   - DNS: `nslookup google.com` (должен резолвить)
   - Сайты: открыть браузер и попробовать зайти на сайт

### Шаг 6: Если не помогло

Попробуйте:

1. **Только Cloudflare DNS:**
   ```bash
   bash fix-dns-russia.sh http://localhost:3000 "1.1.1.1"
   ```

2. **Изменить порт WireGuard** (если блокируется)

3. **Настроить локальный DNS на сервере:**
   ```bash
   bash configure-dns-server.sh
   ```

4. **Проверить логи WireGuard на устройстве пользователя**

## Альтернативные DNS для РФ

### Рекомендуемые (в порядке приоритета):

1. **Cloudflare** (обычно лучше всего):
   ```
   1.1.1.1,1.0.0.1
   ```

2. **Google DNS:**
   ```
   8.8.8.8,8.8.4.4
   ```

3. **AdGuard:**
   ```
   94.140.14.14,94.140.15.15
   ```

4. **Quad9:**
   ```
   9.9.9.9,149.112.112.112
   ```

5. **Yandex DNS:**
   ```
   77.88.8.8,77.88.8.1
   ```
   (Только если нужен доступ к российским сайтам)

### Комбинации:

```
1.1.1.1,8.8.8.8  # Cloudflare + Google (рекомендуется)
1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4  # Все основные (максимальная надежность)
```

## Проверка конфигурации пользователя

Конфигурация должна содержать:

```
[Interface]
PrivateKey = ...
Address = 10.0.0.X/32
DNS = 1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4

[Peer]
PublicKey = ...
Endpoint = 199.247.7.185:51820
AllowedIPs = 0.0.0.0/0,::/0
PresharedKey = ...
PersistentKeepalive = 25
```

**Важно:**
- ✅ `DNS` должен быть указан
- ✅ `AllowedIPs = 0.0.0.0/0,::/0` (весь трафик через VPN)
- ✅ `PersistentKeepalive = 25` (важно для NAT)

## Полезные команды

### На сервере:

```bash
# Статус WireGuard
sudo wg show wg0

# Логи WireGuard
sudo journalctl -u wg-quick@wg0 -n 50

# Проверка маршрутизации
sudo iptables -t nat -L POSTROUTING -v -n
sysctl net.ipv4.ip_forward

# Проверка DNS
dig @1.1.1.1 google.com
```

### На устройстве пользователя:

```bash
# IP адрес
curl ifconfig.me

# DNS резолвинг
nslookup google.com
dig @1.1.1.1 google.com

# Проверка подключения
ping 8.8.8.8
curl -v https://google.com

# Маршрутизация
ip route show
```

## Частые ошибки

1. ❌ **Пользователь использует старую конфигурацию** - нужно пересоздать
2. ❌ **DNS не указан в конфигурации** - обновить DNS на сервере и пересоздать конфиг
3. ❌ **AllowedIPs не включает весь трафик** - должно быть `0.0.0.0/0,::/0`
4. ❌ **NAT правила не настроены** - запустить `fix-wireguard-routing.sh`
5. ❌ **IP forwarding выключен** - включить через `sysctl` или `fix-wireguard-routing.sh`

