# Умный выбор сервера (как в Капусте VPN)

## Обзор

Реализована улучшенная логика выбора VPN серверов, аналогичная Капусте VPN. Система автоматически выбирает лучший сервер для каждого пользователя на основе:

1. **Здоровья сервера** (доступность)
2. **Приоритета** (настройка администратора)
3. **Загрузки** (текущее количество peers / максимальное)
4. **Пинга** (латентность)
5. **Количества peers** (как финальный критерий)

## Как это работает

### Алгоритм выбора сервера

При создании нового peer система:

1. **Фильтрует серверы**: выбирает только активные (`isActive: true`) и здоровые (`isHealthy: true`)
2. **Сортирует по приоритету**:
   - Приоритет 1-10: высокий приоритет (используются в первую очередь)
   - Приоритет 11-50: средний приоритет
   - Приоритет 51-100: низкий приоритет
   - По умолчанию: 100
3. **Учитывает загрузку**: серверы с меньшей загрузкой (`currentPeers / maxPeers`) предпочтительнее
4. **Учитывает пинг**: если доступен, выбирается сервер с меньшим пингом
5. **Финализирует по количеству peers**: если все критерии равны, выбирается сервер с меньшим количеством peers

### Мониторинг здоровья

Система автоматически проверяет здоровье всех серверов каждые **5 минут**:

- **Ping проверка**: измеряет средний пинг до сервера
- **Порт проверка**: проверяет доступность WireGuard порта (UDP)
- **Обновление статуса**: обновляет `isHealthy`, `ping`, `lastHealthCheck`

Сервер считается **нездоровым** если:
- Порт недоступен ИЛИ
- Пинг больше 1000мс

### Fallback логика

Если все серверы помечены как нездоровые (но активные), система:
- Использует активные серверы без учета здоровья
- Выбирает сервер с наименьшей загрузкой

Это позволяет системе продолжать работу даже при временных проблемах с мониторингом.

## Настройка приоритетов

### Через API

```bash
# Установить высокий приоритет для быстрого сервера
curl -X PATCH http://localhost:3000/wireguard/servers/SERVER_ID \
  -H "Content-Type: application/json" \
  -d '{
    "priority": 10,
    "region": "eu"
  }'

# Установить низкий приоритет (резервный сервер)
curl -X PATCH http://localhost:3000/wireguard/servers/SERVER_ID \
  -H "Content-Type: application/json" \
  -d '{
    "priority": 80,
    "region": "backup"
  }'
```

### Через админку

1. Перейти в "Серверы"
2. Найти нужный сервер
3. Изменить `priority` и `region`
4. Сохранить

## Рекомендуемые настройки

### Для России

```yaml
# Основные серверы (высокий приоритет)
server1 (KZ/TR): priority: 10, region: "asia"
server2 (BR):    priority: 20, region: "sa"

# Резервные серверы (средний приоритет)
server3 (EU):    priority: 50, region: "eu"

# Backup серверы (низкий приоритет, используется только при недоступности основных)
server4 (US):    priority: 80, region: "us"
```

### Приоритеты по регионам

- **priority 1-10**: Основные серверы для региона (ближайшие к пользователям)
- **priority 11-30**: Альтернативные серверы в том же регионе
- **priority 31-60**: Серверы в других регионах (fallback)
- **priority 61-100**: Резервные серверы (используются только при недоступности всех остальных)

## Мониторинг

### Проверка здоровья вручную

```bash
# Проверить все серверы
curl -X POST http://localhost:3000/wireguard/servers/health-check

# Проверить конкретный сервер
curl -X POST http://localhost:3000/wireguard/servers/SERVER_ID/health-check
```

### Просмотр статуса

```bash
# Получить список всех серверов со статусом
curl http://localhost:3000/wireguard/servers | jq '.[] | {name, isHealthy, ping, priority, currentPeers, maxPeers}'
```

### В админке

Админка автоматически показывает:
- ✅ Здоровые серверы
- ❌ Нездоровые серверы
- Пинг (если доступен)
- Последнюю проверку здоровья

## Автоматические задачи

### Cron задача проверки здоровья

```typescript
// Запускается каждые 5 минут
@Cron(CronExpression.EVERY_5_MINUTES)
async handleHealthCheck() {
  await this.healthCheckService.checkAllServers();
}
```

### Настройка интервала

Чтобы изменить интервал проверки, отредактируйте `backend/src/wireguard/health-check.task.ts`:

```typescript
// Каждые 3 минуты
@Cron('*/3 * * * *')

// Каждую минуту (не рекомендуется для большого количества серверов)
@Cron(CronExpression.EVERY_MINUTE)
```

## Преимущества

1. **Автоматический выбор лучшего сервера** - пользователи всегда подключаются к оптимальному серверу
2. **Устойчивость к сбоям** - система автоматически исключает недоступные серверы
3. **Балансировка нагрузки** - пользователи распределяются между серверами равномерно
4. **Гибкая настройка** - можно настроить приоритеты для разных сценариев
5. **Мониторинг в реальном времени** - всегда видно состояние всех серверов

## Миграция существующих серверов

Существующие серверы автоматически получают:
- `priority: 100` (по умолчанию)
- `isHealthy: true` (до первой проверки)
- `region: null` (можно установить вручную)

Для обновления существующих серверов:

```bash
# Обновить все серверы через API
curl http://localhost:3000/wireguard/servers | jq -r '.[].id' | while read id; do
  curl -X PATCH http://localhost:3000/wireguard/servers/$id \
    -H "Content-Type: application/json" \
    -d '{"priority": 50, "region": "default"}'
done
```

## Примеры использования

### Сценарий 1: Основной и резервный сервер

```bash
# Основной сервер (Германия)
SERVER_ID_1="..."
curl -X PATCH http://localhost:3000/wireguard/servers/$SERVER_ID_1 \
  -H "Content-Type: application/json" \
  -d '{"priority": 10, "region": "eu"}'

# Резервный сервер (Бразилия)
SERVER_ID_2="..."
curl -X PATCH http://localhost:3000/wireguard/servers/$SERVER_ID_2 \
  -H "Content-Type: application/json" \
  -d '{"priority": 50, "region": "sa"}'
```

### Сценарий 2: Географическое распределение

```bash
# Серверы в разных регионах с разными приоритетами
# Европа (ближе к России)
curl -X PATCH ... -d '{"priority": 10, "region": "eu"}'

# Азия (ближе к России)
curl -X PATCH ... -d '{"priority": 15, "region": "asia"}'

# Северная Америка (fallback)
curl -X PATCH ... -d '{"priority": 60, "region": "us"}'
```

## Troubleshooting

### Сервер не выбирается

1. Проверьте что сервер активен: `isActive: true`
2. Проверьте здоровье: `isHealthy: true`
3. Проверьте приоритет: чем меньше, тем выше приоритет
4. Проверьте загрузку: `currentPeers < maxPeers`

### Сервер помечен как нездоровый

1. Проверьте доступность сервера: `ping SERVER_IP`
2. Проверьте WireGuard порт: `nc -u -z SERVER_IP PORT`
3. Запустите проверку вручную: `POST /wireguard/servers/SERVER_ID/health-check`
4. Проверьте логи: `journalctl -u vpn-backend -f`

### Низкая производительность

1. Проверьте пинг серверов: должны быть < 200мс для хорошей работы
2. Настройте приоритеты: ближайшие серверы должны иметь приоритет 1-20
3. Увеличьте `maxPeers` если серверы перегружены
4. Добавьте больше серверов в регионе с высоким приоритетом

