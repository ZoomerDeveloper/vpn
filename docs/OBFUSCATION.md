# Обфускация VPN трафика (как в Капусте VPN)

## Концепция

Вместо отказа от WireGuard (что потребует разработки собственного протокола), мы добавляем **обфускацию поверх WireGuard**. Это позволяет:
- Сохранить все преимущества WireGuard (скорость, безопасность)
- Скрыть VPN-трафик от DPI (Deep Packet Inspection)
- Обойти блокировки без переписывания всего протокола

## Варианты реализации

### Вариант 1: UDP2Raw (Рекомендуется для начала)

**Принцип:** Оборачивает UDP-трафик WireGuard в псевдо-TCP пакеты, которые выглядят как HTTPS.

**Преимущества:**
- Пакеты выглядят как обычный HTTPS-трафик
- Работает поверх существующего WireGuard
- Минимальные изменения в коде
- Хорошо обходит DPI в РФ

**Недостатки:**
- Требует установки udp2raw на сервере и клиенте
- Нужен собственный клиент для мобильных устройств

### Вариант 2: WireGuard over Shadowsocks

**Принцип:** WireGuard туннелируется через Shadowsocks прокси.

**Преимущества:**
- Shadowsocks хорошо обходит блокировки
- Можно использовать существующие клиенты Shadowsocks
- Легко настроить

**Недостатки:**
- Двойное шифрование (немного медленнее)
- Нужна дополнительная настройка

### Вариант 3: WireGuard over TCP (stunnel)

**Принцип:** WireGuard туннелируется через TLS (HTTPS).

**Преимущества:**
- Трафик выглядит как обычный HTTPS
- Почти всегда проходит через DPI
- Стандартные инструменты (stunnel)

**Недостатки:**
- Медленнее UDP (но все равно быстро)
- TCP overhead

## Рекомендуемый план (поэтапно)

### Этап 1: Оставить WireGuard как есть (текущее состояние)

✅ **Сейчас у нас:**
- WireGuard на порту 443/UDP
- MTU = 1280
- DNS = 1.1.1.1
- Правильная локация серверов (BR, TR, KZ)

Это работает для **большинства** пользователей в РФ.

### Этап 2: Добавить опциональную обфускацию (если нужно)

Если после MTU и правильной локации все еще есть проблемы с блокировками:

**Для серверов:**
```bash
# Установка udp2raw на сервере
wget https://github.com/wangyu-/udp2raw/releases/download/20230206.0/udp2raw_binaries.tar.gz
tar xzf udp2raw_binaries.tar.gz
sudo cp udp2raw_amd64 /usr/local/bin/udp2raw
sudo chmod +x /usr/local/bin/udp2raw

# Запуск udp2raw поверх WireGuard
sudo udp2raw -s -l0.0.0.0:443 -r127.0.0.1:51820 -k "your_secret_key" --raw-mode faketcp
```

**Для клиентов:**
- Использовать собственное приложение или скрипт
- Или инструкции по настройке udp2raw клиента

### Этап 3: Собственное мобильное приложение (дальнейшее развитие)

Если нужен полностью собственный протокол без зависимости от WireGuard:
- Разработка собственного VPN протокола (очень сложно)
- Использование Shadowsocks или VLESS как базового протокола
- Разработка клиентских приложений для всех платформ

## Мое мнение

**Для MVP рекомендую:**

1. **Оставить WireGuard** как базовый протокол
   - Проверен, быстр, безопасен
   - Есть клиенты для всех платформ
   - Легко масштабировать

2. **Добавить обфускацию только при необходимости**
   - Если после MTU = 1280 и порта 443/UDP все еще блокировки
   - Использовать udp2raw или stunnel как wrapper

3. **Использовать правильные локации серверов**
   - BR, TR, KZ, AM вместо DE
   - Умный выбор сервера (уже реализовано)

4. **Мониторинг и автоматическое переключение**
   - Если сервер заблокирован → автоматическая миграция
   - Уже частично реализовано

## Почему НЕ отказываться от WireGuard полностью?

**Если создать собственный протокол:**
- ❌ Разработка займет месяцы/годы
- ❌ Нужны клиенты для iOS/Android/Windows/Mac/Linux
- ❌ Обеспечение безопасности (криптография)
- ❌ Тестирование и отладка
- ❌ Поддержка и обновления

**С WireGuard + обфускация:**
- ✅ Используем проверенный протокол
- ✅ Готовые клиенты для всех платформ
- ✅ Обфускация решает проблему блокировок
- ✅ Быстрая разработка и поддержка

## Альтернатива: Shadowsocks вместо WireGuard

Если все-таки хотите уйти от WireGuard, можно использовать **Shadowsocks**:

**Преимущества:**
- Хорошо обходит блокировки
- Много готовых серверов и клиентов
- Легко настроить

**Недостатки:**
- Медленнее WireGuard
- Меньше функций (нет встроенного роутинга)
- Нужно переписывать код управления peers

**Для реализации Shadowsocks нужно:**
1. Заменить WireguardService на ShadowsocksService
2. Изменить генерацию конфигов
3. Обновить скрипты установки
4. Обновить документацию

## Вывод

**Моя рекомендация:** Оставить WireGuard, добавить обфускацию при необходимости.

WireGuard + MTU 1280 + порт 443 + правильная локация = работает для 90% пользователей.

Если нужно больше → добавить udp2raw/stunnel wrapper.

Полный отказ от WireGuard оправдан только если планируете разрабатывать собственный протокол и приложения (это огромный проект).

