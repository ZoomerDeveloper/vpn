# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MTU –¥–ª—è —Ä–∞–±–æ—Ç—ã VPN –≤ –†–§

## üö® –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- ‚úÖ Handshake –∞–∫—Ç–∏–≤–µ–Ω (peer –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è)
- ‚ùå –¢—Ä–∞—Ñ–∏–∫ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
- ‚úÖ Allowed IPs –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–ü—Ä–∏—á–∏–Ω–∞:** MTU mismatch - –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π MTU (~1420), –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ DPI –≤ –†–§.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –®–ê–ì 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å MTU = 1280 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ WireGuard

```bash
cd /opt/vpn-service/scripts
bash fix-server-mtu.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
# 1. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
sudo nano /etc/wireguard/wg0.conf

# 2. –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–∫—Ü–∏—é [Interface]:
MTU = 1280

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å WireGuard
sudo systemctl restart wg-quick@wg0

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
ip link show wg0 | grep mtu
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: mtu 1280
```

**–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞:**
```
[Interface]
Address = 10.0.0.1/24
ListenPort = 443
PrivateKey = SERVER_PRIVATE_KEY
MTU = 1280
PostUp = iptables -A FORWARD -i %i -j ACCEPT; ...
PostDown = iptables -D FORWARD -i %i -j ACCEPT; ...
```

### –®–ê–ì 2: –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –í–°–ï –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏

‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –°—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –ë–ï–ó MTU –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!

**–ù–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∞—Ç MTU = 1280** (–¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥).

–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏:

**–ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É:**
1. –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ù–∞–∂–∞—Ç—å "‚úï" (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å peer)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

**–ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç:**
```bash
cd /opt/vpn-service/scripts

# –ù–∞–π—Ç–∏ USER_ID
bash get-user-id.sh TELEGRAM_ID

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
bash recreate-user-config.sh USER_ID
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥:**
```
[Interface]
PrivateKey = ...
Address = 10.0.0.X/32
DNS = 1.1.1.1
MTU = 1280

[Peer]
PublicKey = SERVER_PUBLIC_KEY
Endpoint = SERVER_IP:443
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
```

### –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NAT (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)

```bash
# IP forwarding
sysctl net.ipv4.ip_forward
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: net.ipv4.ip_forward = 1

# NAT –ø—Ä–∞–≤–∏–ª–∞
sudo iptables -t nat -L POSTROUTING -n
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª–æ MASQUERADE

# –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–∏—Ç—å:
MAIN_IF=$(ip route | grep default | awk '{print $5}' | head -1)
sudo iptables -t nat -A POSTROUTING -o $MAIN_IF -j MASQUERADE
```

## üéØ –ü–æ—á–µ–º—É MTU = 1280?

- **1280** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π MTU –¥–ª—è IPv6, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –ª—é–±—ã–µ —Å–µ—Ç–∏
- **1420** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π MTU WireGuard, –Ω–æ —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è DPI –≤ –†–§
- **1300-1380** - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø—Ä–æ –ª–æ–∫–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –ì–µ—Ä–º–∞–Ω–∏–µ–π (Frankfurt):**
- IP-–¥–∏–∞–ø–∞–∑–æ–Ω—ã DE —á–∞—Å—Ç–æ –≤ —Å–ø–∏—Å–∫–∞—Ö DPI –†–§
- –ú–Ω–æ–≥–æ VPN-—Ç—Ä–∞—Ñ–∏–∫–∞ ‚Üí –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã
- –î–∞–∂–µ –Ω–∞ –ø–æ—Ä—Ç—É 443/UDP –º–æ–≥—É—Ç —Ä–µ–∑–∞—Ç—å—Å—è data packets

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –†–§:**
- üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
- üáπüá∑ –¢—É—Ä—Ü–∏—è
- üá¶üá≤ –ê—Ä–º–µ–Ω–∏—è
- üá∑üá∏ –°–µ—Ä–±–∏—è

## üß® –ï—Å–ª–∏ –ø–æ—Å–ª–µ MTU –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç DPI –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∂–µ—Ç DATA-–ø–∞–∫–µ—Ç—ã WireGuard.

**–ü–ª–∞–Ω B:**
1. **WG + obfuscation** (udp2raw) - –ø–∞–∫–µ—Ç—ã –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ HTTPS
2. **WG over TCP 443** (stunnel) - –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞
3. **–°–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é VPS** –Ω–∞ KZ/TR/AM/RS

## ‚úÖ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è MTU = 1280 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤:
- **~70%** —á—Ç–æ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É
- **~20%** —á—Ç–æ –Ω—É–∂–Ω–∞ —Å–º–µ–Ω–∞ –ª–æ–∫–∞—Ü–∏–∏
- **~10%** —á—Ç–æ –Ω—É–∂–µ–Ω obfuscation

